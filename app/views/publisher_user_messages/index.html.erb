<!-- Template from http://www.bypeople.com/simple-chat-conversation/ -->

<style type="text/css">
	.header
	{
	  font-size:26px;
	  margin:0 auto;
	  text-align:center;
	  color:#9F6905;
	  font-weight:lighter;
	  background-color:#f0f0f0;
	  height:50px;
	  line-height:50px;
	  border-bottom:1px solid #9F6905;
	}
	.container
	{
	  width:600px;
	  cursor:default;
	  margin:20px auto;
	  max-height:500px;
	  overflow-y:scroll;
	}
	.container::-webkit-scrollbar 
	{
	width: 3px;
	max-width: 3px;
	height: auto;
	max-height: 8px;
	}
	.container::-webkit-scrollbar-thumb 
	{
	background: #f0f0f0;
	border-radius: 5px;
	max-width: 3px;
	}
	.container::-webkit-scrollbar-track {
	background: #9F6905;
	  border-radius:5px;
	}
	.Area
	{
	  margin:0 auto;
	  width:400px;
	  background-color:rgba(240, 240, 240, 0.2);
	  display:table;
	  padding:5px;
	  border-radius:5px;
	  margin-bottom:10px;
	}
	.L
	{
	  float:left;
	}
	.Area img
	{
	  width:50px;
	  height:50px;
	  border-radius:50%;
	  border:2px solid #f0f0ff;
	  padding:5px;    
	}
	.Area img:hover
	{
	    -moz-box-shadow: 0 5px 5px rgba(223, 120, 8, 1);
		-webkit-box-shadow: 0 5px 5px rgba(223, 120, 8, 1);
		box-shadow: 0 5px 5px rgba(223, 120, 8, 1);
	    -webkit-transition: all 1.5s;
	    -moz-transition: all 1.5s;
	    transition: all 1.5s;
		cursor:pointer;
	}
	.R
	{
	    float:right;
	}
	.text
	{
		color: #a4a4a4;
		font-family: tahoma;
		font-size: 13px;
		font-weight:lighter;
		line-height: 30px;
		width:300px;
		border:1px solid #f0f0f0;
		background-color:rgba(255, 255, 255, 0.6);
		margin-top:10px;
		border-radius:5px;
		padding:5px;  
	}
	.Area textarea
	{
	  font-size:12px;
	  width:90%;
	  max-width:90%;
	  min-width:90%;
	  padding:5%;
	  border-radius:5px;
	  border:1px solid #f0f0f1;
	  max-height:50px;
	  height:50px;
	  min-height:50px;
	  background-color:#333;
	  color:#fff;
	  outline:none;
	  border:1px solid transparent;
	  resize:none;
	}
	.Area textarea:focus
	{
		color:#333;
		border:1px solid #ccc;
		-webkit-transition: all 1.5s;
		-moz-transition: all 1.5s;
		transition: all 1.5s;
		background-color:#fff;
	}
	.Area .note
	{
	  color:#9F6905;
	  font-size:10px;
	}
	.R .tooltip
	{
	  font-size:10px;
	  position:absolute;
	  background-color:#fff;
	  padding:5px;
	  border-radius:5px;
	  border:2px solid #9F6905;
	  margin-left:70px;
	  margin-top:-70px;
	  display:none;
	  color:#545454;
	}
	.R .tooltip:before
	{
	    content: '';
	    position: absolute;
	    width: 1px;
	    height: 1px;
	    border: 5px solid transparent;
	    border-right-color: #9F6905;
	    margin-top: 10px;
	    margin-left: -17px;
	}
	.R:hover .tooltip
	{
	  display:block;
	}
	.L .tooltip
	{
	  font-size:10px;
	  position:absolute;
	  background-color:#fff;
	  padding:5px;
	  border-radius:5px;
	  border:2px solid #9F6905;
	  margin-left:70px;
	  margin-top:-70px;
	  display:none;  
	  color:#545454;
	}
	.L .tooltip:before
	{
	    content: '';
	    position: absolute;
	    width: 1px;
	    height: 1px;
	    border: 5px solid transparent;
	    border-right-color: #9F6905;
	    margin-top: 10px;
	    margin-left: -17px;
	}
	.L:hover .tooltip
	{
	  display:block;
	}
	a
	{
	  text-decoration:none;
	}
	.Area input[type=button], .Area input[type=submit]
	{
	  font-size:12px;
	  padding:5px;
	  border-radius:5px;
	  border:1px solid #f0f0f1;
	  background-color:#333;
	  color:#fff;
	  outline:none;
	  border:1px solid transparent;
	  float:left;
	}
	.Area input[type=button]:hover, .Area input[type=submit]:hover
	{
	  color:#fff;
	  border:1px solid #ccc;
	     -webkit-transition: all 1.5s;
	    -moz-transition: all 1.5s;
	    transition: all 1.5s;
	  background-color:#9F6905;
	}
	.validation
	{
	  float:left;
	  background-color:#ccc;
	  border-radius:5px;
	  padding:5px;
	  font-size:12px;
	  line-height:14px;
	  height:0px;
	  margin-left:5px;
	  display:none;
	}
	br
	{
	  clear:both;
	  height:20px;
	}
</style>

<!-- <div class="header">Conversation</div> -->
<div style="position: relative;">
	<div style="float: left; width: 150px">
		<%= render 'users' %>
		<%= render 'conversations' %>
	</div>
	<div style="width: 50px"></div>
	<div style="float: right">
		<div style="display: inline">Current dialog_id:</div>
		<div id="current_dialog_id" style="display: inline"></div>
		<div id="dialog_container" class="container">
			<div id="dialog_id_1" style="background: lightgreen"></div>
			<div id="dialog_id_0" style="background: lightblue"></div>
			<div id="dialog_id_2"></div>
			<!-- <div class="Area">
				<div class="L">
					<a href="https://twitter.com/SamiMassadeh">
					<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRrEyVlaWx0_FK_sz86j-CnUC_pfEqw_Xq_xZUm5CMIyEI_-X2hRUpx1BHL"/>
					<div class="tooltip">Sami Massadeh - 28 Years<br/>Doctor <br/>Jordan</div></a>
				</div>
				<div class="text R textR">Hi Mariam, How Are You?
				</div>
			</div>
			<div class="Area"> 
				<div class="R">
					<a href="https://twitter.com/MariamMassadeh">
					<img src="https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSxU35znsBhAWQd5BouLIVtH1P4WNa0JZ_XXpyViHOIARbM2igbNgC6_kp5"/>
					<div class="tooltip">Mariam Massadeh - 23 Years<br/>Computer Engineer<br/>Jordan</div></a>
				</div>    
				<div class="text L textL">Hi Sami, Fine, Thank You, How Are You?
				</div>        
			</div> --> 
		</div>
		<div class="Area">
			<!-- <textarea id="new_message" placeholder="Participate in coversation"></textarea>
			<br/><br/> -->
			<input type="button" onclick="sendMessage()" value="OLD SEND"/>
			<br/><br/>
			<%= form_tag({action: 'send_message'}, remote: true) do %>
				<%= hidden_field_tag :dialog_id, @last_dialog.dialog_id %>
				<%= text_area_tag :new_message, nil, :placeholder => "Participate in coversation" %>
				<br/><br/>
				<%= submit_tag("SEND") %>
			<% end %>
			<input id="input_dialog_id" type="text" value="1"/>
			<div class="validation">You Are Not Registered</div>
			<br/>
			<p class="note">* for any help return to adminstrator..</p>
		</div>
	</div>
	<div style="clear: both"></div>
</div>

<script type="text/javascript">
	// Stomp client for url 
	client = Stomp.client("wss://webknow/websockets", "v11.stomp");  
	// Connect to Torquebox, executing the function when connected 
	client.connect("", "", function(frame) { 
		// Subscribe to the demo queue to fire callback 
		client.subscribe("/queue/demo", onMessage); 
		// Send a test message 
		client.send( "/queue/demo", {}, "This is a test of the Demo" ); 
	}); 
	// Disconnect client on close 
	$(window).unload(function() { 
		client.disconnect(); 
	});
	String.format = function() {
	    // The string containing the format items (e.g. "{0}")
	    // will and always has to be the first argument.
	    var theString = arguments[0];
	    
	    // start with the second argument (i = 1)
	    for (var i = 1; i < arguments.length; i++) {
	        // "gm" = RegEx options for Global search (more than one instance)
	        // and for Multiline search
	        var regEx = new RegExp("\\{" + (i - 1) + "\\}", "gm");
	        theString = theString.replace(regEx, arguments[i]);
	    }
	    
	    return theString;
	}
	onMessage = function(msg) { 
		// alert(msg);
		// var message = String.format('<p>{0}: {1}</p>',
  //                            msg.headers.sender, msg.body);
		var message = String.format('<div class="Area Message">' + 
										'<div class="L">' + 
											'<a href="{0}">' +
											'<img src="{1}"/>' +
											'<div class="tooltip">{2}</div></a>' +
										'</div>' +
										'<div class="text R textR">{3}</div>' +
									'</div>', "/" + msg.headers.sender_slug, msg.headers.sender_image, msg.headers.sender, msg.body);
		// var dialog_container = $("#dialog_id_" + msg.headers.dialog_id);
		var dialog_container = $("#dialog_container");

		if(dialog_container.length != 0) {
			dialog_container.append($(message));
			var container = $('.container'),
	    		scrollTo = $('.Message').last();
			container.animate({
			    scrollTop: scrollTo.offset().top - container.offset().top + container.scrollTop()
			}, 500);
		}
	}
	function sendMessage() {
		client.send( "/queue/demo", { dialog_id: $("#dialog_id").val() }, $("#new_message").val() );
		$("#new_message").val("");
	}
	$('#messageForm').submit(function () {
		sendMessage();
		return false;
	});
</script>